tinymce.PluginManager.add("cloudinarybrowser", function (editor, url) {
	var optsToPass = ['modelName', 'fieldName', 'listPath', 'itemName'];
	var params = optsToPass.map(function(o) {
		return o + '=' + editor.settings[o];
	}).join('&');
	var browseUrl = '/keystone/tiny-mce-plugin/cloudinarybrowser?' + params;
	editor.addButton("cloudinarybrowser", {
		//text: "Browse Cloudinary",
		icon: 'image',
		tooltip: 'Insert an image',
		onClick: function() {
			editor.windowManager.open({
				title: 'Browse Images',
				width: 640,
				height: 350,
				url: browseUrl,
				buttons: [{
					text: "Save",
					onclick: function(e) {
						var frame = $(e.target).parents(".mce-reset").find("iframe").first();
						frame[0].contentDocument.postThumbnails();
					}
				}, {
					text: "Cancel",
					onclick: "close"
				}]
			})
		}
	});
});